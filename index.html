<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple Token Sender DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    button { margin: 5px 0; padding: 10px; }
    input, select { margin-bottom: 10px; width: 300px; padding: 8px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>
  <h1>Simple Token Sender DApp</h1>
  <div class="section">
    <button onclick="connectWallet()">连接钱包</button>
    <p id="walletAddress">未连接</p>
  </div>

  <div class="section">
    <h3>添加交易对</h3>
    <input id="tokenAddress" placeholder="Token地址" /><br>
    <input id="receiverAddress" placeholder="接收者地址" /><br>
    <input id="pairName" placeholder="名称（自定义）" /><br>
    <button onclick="addPair()">添加</button>
  </div>

  <div class="section">
    <h3>控制功能</h3>
    <input id="pairIndex" placeholder="交易对编号" /><br>
    <select id="pairStatus">
      <option value="true">启用</option>
      <option value="false">停用</option>
    </select><br>
    <button onclick="togglePair()">设置交易对状态</button>

    <select id="autoTransfer">
      <option value="true">开启自动转账</option>
      <option value="false">关闭自动转账</option>
    </select><br>
    <button onclick="toggleAutoTransfer()">设置自动转账</button><br>

    <input id="newGasLimit" placeholder="新的 maxGasPerPair" /><br>
    <button onclick="setMaxGas()">修改 maxGasPerPair</button><br>

    <input id="newMaxGasPrice" placeholder="新的最大 gasPrice (wei)" /><br>
    <button onclick="setMaxGasPrice()">修改最大 gasPrice</button>
  </div>

  <div class="section">
    <h3>执行功能</h3>
    <button onclick="executeTransfers()">立即执行转账</button>
  </div>

  <div class="section">
    <h3>查询状态</h3>
    <button onclick="checkCanExecute()">是否可执行转账</button>
    <button onclick="getPairs()">查看所有交易对</button>
    <button onclick="getGasSettings()">查看 Gas 设置</button>
    <button onclick="getTransferInfo()">转账状态/上次时间</button>
  </div>

  <script>
    let web3;
    let contract;
    const contractAddress = "0x58753f500A22420784f277439b358e3d6cb44AFa";
    const abi = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "addPair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "executeTransfers",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "bool",
				"name": "enabled",
				"type": "bool"
			}
		],
		"name": "AutoTransferToggled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newMaxGas",
				"type": "uint256"
			}
		],
		"name": "MaxGasPerPairUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newMaxGasPrice",
				"type": "uint256"
			}
		],
		"name": "MaxGasPriceUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "PairAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "PairToggled",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newMaxGas",
				"type": "uint256"
			}
		],
		"name": "setMaxGasPerPair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newMaxGasPrice",
				"type": "uint256"
			}
		],
		"name": "setMaxGasPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "enabled",
				"type": "bool"
			}
		],
		"name": "toggleAutoTransfer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "togglePair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "pairCount",
				"type": "uint256"
			}
		],
		"name": "TransferExecuted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "autoTransferEnabled",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "canExecuteNow",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FIXED_AMOUNT",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FIXED_INTERVAL",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllPairs",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "receiver",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "isActive",
						"type": "bool"
					},
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					}
				],
				"internalType": "struct SimpleTokenSender.Pair[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lastGlobalTransferTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "maxGasPerPair",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "maxGasPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "pairs",
		"outputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // 替换为你的 ABI

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        document.getElementById("walletAddress").innerText = accounts[0];
        contract = new web3.eth.Contract(abi, contractAddress);
      } else {
        alert("请使用支持以太坊的钱包，如MetaMask");
      }
    }

    async function addPair() {
      const token = document.getElementById("tokenAddress").value;
      const receiver = document.getElementById("receiverAddress").value;
      const name = document.getElementById("pairName").value;
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.addPair(token, receiver, name).send({ from: account });
    }

    async function togglePair() {
      const index = document.getElementById("pairIndex").value;
      const status = document.getElementById("pairStatus").value === 'true';
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.togglePair(index, status).send({ from: account });
    }

    async function toggleAutoTransfer() {
      const enabled = document.getElementById("autoTransfer").value === 'true';
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.toggleAutoTransfer(enabled).send({ from: account });
    }

    async function setMaxGas() {
      const newGas = document.getElementById("newGasLimit").value;
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.setMaxGasPerPair(newGas).send({ from: account });
    }

    async function setMaxGasPrice() {
      const newPrice = document.getElementById("newMaxGasPrice").value;
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.setMaxGasPrice(newPrice).send({ from: account });
    }

    async function executeTransfers() {
      const account = (await web3.eth.getAccounts())[0];
      await contract.methods.executeTransfers().send({ from: account });
    }

    async function checkCanExecute() {
      const result = await contract.methods.canExecuteNow().call();
      alert("可执行转账: " + result);
    }

    async function getPairs() {
      const pairs = await contract.methods.getAllPairs().call();
      console.log("交易对：", pairs);
      alert("共" + pairs.length + "个交易对。详情见控制台。")
    }

    async function getGasSettings() {
      const gas = await contract.methods.maxGasPerPair().call();
      const price = await contract.methods.MAX_GASPRICE().call();
      alert(`Gas/交易对：${gas}\n最大Gas价格：${price} wei`);
    }

    async function getTransferInfo() {
      const lastTime = await contract.methods.lastGlobalTransferTime().call();
      const enabled = await contract.methods.autoTransferEnabled().call();
      const owner = await contract.methods.owner().call();
      alert(`上次转账时间戳：${lastTime}\n自动转账：${enabled}\n合约Owner：${owner}`);
    }
  </script>
</body>
</html>
