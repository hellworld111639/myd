<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BatchTokenTransfer DApp</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
  input, button { padding: 0.5rem; margin: 0.3rem 0; width: 100%; box-sizing: border-box; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
  th { background-color: #eee; }
  .toggle-btn { cursor: pointer; padding: 4px 8px; border-radius: 4px; border: none; }
  .active { background-color: #4CAF50; color: white; }
  .inactive { background-color: #f44336; color: white; }
  #status { margin: 1rem 0; font-weight: bold; }
</style>
<script src="https://cdn.ethers.io/lib/ethers-5.7.2.min.js" type="application/javascript"></script>
</head>
<body>

<h2>BatchTokenTransfer DApp</h2>

<button id="connectBtn">Connect Wallet</button>
<div id="account"></div>

<h3>Pairs List</h3>
<div>
  Total pairs: <span id="pairsCount">0</span>
</div>
<table id="pairsTable">
  <thead>
    <tr><th>Index</th><th>Token Address</th><th>Receiver Address</th><th>Active</th><th>Toggle</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Add New Pair</h3>
<input type="text" id="tokenAddress" placeholder="Token contract address" />
<input type="text" id="receiverAddress" placeholder="Receiver address" />
<button id="addPairBtn">Add Pair</button>

<h3>Execute Transfers</h3>
<button id="execTransfersBtn">Execute Transfers</button>

<div id="status"></div>

<script>
  const CONTRACT_ADDRESS = "0x367c6795D93C1393D3ba0b74046f7f7f59eaE515"; // 替换成你的合约地址
  const CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "addPair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "executeTransfers",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "PairAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "PairToggled",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "active",
				"type": "bool"
			}
		],
		"name": "togglePair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "total",
				"type": "uint256"
			}
		],
		"name": "TransfersExecuted",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "FIXED_AMOUNT",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPairsCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "pairs",
		"outputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]

  let provider, signer, contract;

  const connectBtn = document.getElementById("connectBtn");
  const accountDiv = document.getElementById("account");
  const pairsCountSpan = document.getElementById("pairsCount");
  const pairsTableBody = document.querySelector("#pairsTable tbody");
  const addPairBtn = document.getElementById("addPairBtn");
  const execTransfersBtn = document.getElementById("execTransfersBtn");
  const statusDiv = document.getElementById("status");

  async function connectWallet() {
    if (!window.ethereum) {
      alert("Please install MetaMask!");
      return;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    const address = await signer.getAddress();
    accountDiv.textContent = "Connected: " + address;

    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

    await loadPairs();
  }

  async function loadPairs() {
    pairsTableBody.innerHTML = "";
    const count = await contract.getPairsCount();
    pairsCountSpan.textContent = count.toString();

    for (let i = 0; i < count; i++) {
      const pair = await contract.pairs(i);
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${i}</td>
        <td>${pair.token}</td>
        <td>${pair.receiver}</td>
        <td>${pair.isActive ? "Yes" : "No"}</td>
        <td><button class="toggle-btn ${pair.isActive ? "active" : "inactive"}" data-index="${i}">${pair.isActive ? "Disable" : "Enable"}</button></td>
      `;

      pairsTableBody.appendChild(tr);
    }

    // 给 toggle 按钮添加事件
    document.querySelectorAll(".toggle-btn").forEach(btn => {
      btn.onclick = async (e) => {
        const index = e.target.getAttribute("data-index");
        const newActive = !(e.target.textContent === "Disable");
        try {
          statusDiv.textContent = "Sending toggle transaction...";
          const tx = await contract.togglePair(index, newActive);
          await tx.wait();
          statusDiv.textContent = "Toggle successful!";
          await loadPairs();
        } catch (error) {
          statusDiv.textContent = "Error: " + error.message;
        }
      };
    });
  }

  addPairBtn.onclick = async () => {
    const token = document.getElementById("tokenAddress").value.trim();
    const receiver = document.getElementById("receiverAddress").value.trim();

    if (!ethers.utils.isAddress(token)) {
      alert("Invalid token address");
      return;
    }
    if (!ethers.utils.isAddress(receiver)) {
      alert("Invalid receiver address");
      return;
    }

    try {
      statusDiv.textContent = "Sending addPair transaction...";
      const tx = await contract.addPair(token, receiver);
      await tx.wait();
      statusDiv.textContent = "Pair added successfully!";
      document.getElementById("tokenAddress").value = "";
      document.getElementById("receiverAddress").value = "";
      await loadPairs();
    } catch (error) {
      statusDiv.textContent = "Error: " + error.message;
    }
  };

  execTransfersBtn.onclick = async () => {
    try {
      statusDiv.textContent = "Sending executeTransfers transaction...";
      const tx = await contract.executeTransfers();
      await tx.wait();
      statusDiv.textContent = "Transfers executed!";
    } catch (error) {
      statusDiv.textContent = "Error: " + error.message;
    }
  };

  connectBtn.onclick = connectWallet;
</script>

</body>
</html>
