<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Batch Token Transfer DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }
    button {
      margin-top: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    input {
      margin-bottom: 5px;
      padding: 4px;
      width: 100%;
    }
    .pair {
      border: 1px solid #ddd;
      padding: 6px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h2>BatchTokenTransfer DApp</h2>

  <button onclick="connectWallet()">ğŸ”Œ è¿æ¥é’±åŒ…</button>
  <p id="walletAddress"></p>

  <h3>â• æ·»åŠ äº¤æ˜“å¯¹</h3>
  <input id="tokenAddress" placeholder="ä»£å¸åœ°å€">
  <input id="receiverAddress" placeholder="æ¥æ”¶è€…åœ°å€">
  <button onclick="addPair()">æ·»åŠ äº¤æ˜“å¯¹</button>

  <h3>ğŸ“‹ å½“å‰äº¤æ˜“å¯¹</h3>
  <div id="pairList"></div>

  <h3>ğŸš€ æ‰§è¡Œæ‰¹é‡è½¬è´¦</h3>
  <button onclick="executeTransfers()">æ‰§è¡Œè½¬è´¦</button>

  <h3>ğŸ‘‘ è½¬ç§»æ‰€æœ‰æƒ</h3>
  <input id="newOwner" placeholder="æ–°æ‰€æœ‰è€…åœ°å€">
  <button onclick="transferOwnership()">è½¬ç§»æƒé™</button>

  <script>
    const contractAddress = "0x367c6795D93C1393D3ba0b74046f7f7f59eaE515"; // <-- æ›¿æ¢ä¸ºä½ çš„åˆçº¦åœ°å€
    const contractABI = [ // å¤åˆ¶ ABI ä¸­ç›¸å…³å‡½æ•°å³å¯
      "function addPair(address token, address receiver) external",
      "function togglePair(uint256 index, bool active) external",
      "function executeTransfers() external",
      "function transferOwnership(address newOwner) external",
      "function getPairsCount() external view returns (uint256)",
      "function pairs(uint256) external view returns (address token, address receiver, bool isActive)"
    ];

    let provider, signer, contract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("è¯·å…ˆå®‰è£… MetaMask");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const address = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "å·²è¿æ¥: " + address;
      contract = new ethers.Contract(contractAddress, contractABI, signer);
      loadPairs();
    }

    async function addPair() {
      const token = document.getElementById("tokenAddress").value;
      const receiver = document.getElementById("receiverAddress").value;
      try {
        const tx = await contract.addPair(token, receiver);
        await tx.wait();
        alert("æ·»åŠ æˆåŠŸ");
        loadPairs();
      } catch (err) {
        alert("æ·»åŠ å¤±è´¥: " + err.message);
      }
    }

    async function loadPairs() {
      const pairList = document.getElementById("pairList");
      pairList.innerHTML = "åŠ è½½ä¸­...";
      try {
        const count = await contract.getPairsCount();
        let html = "";
        for (let i = 0; i < count; i++) {
          const pair = await contract.pairs(i);
          html += `
            <div class="pair">
              <b>ç´¢å¼• ${i}</b><br>
              Token: ${pair.token}<br>
              Receiver: ${pair.receiver}<br>
              çŠ¶æ€: ${pair.isActive ? "âœ…å¯ç”¨" : "âŒåœç”¨"}<br>
              <button onclick="togglePair(${i}, ${!pair.isActive})">
                ${pair.isActive ? "åœç”¨" : "å¯ç”¨"}
              </button>
            </div>
          `;
        }
        pairList.innerHTML = html || "æš‚æ— äº¤æ˜“å¯¹";
      } catch (err) {
        pairList.innerHTML = "åŠ è½½å¤±è´¥: " + err.message;
      }
    }

    async function togglePair(index, active) {
      try {
        const tx = await contract.togglePair(index, active);
        await tx.wait();
        alert("çŠ¶æ€æ›´æ–°æˆåŠŸ");
        loadPairs();
      } catch (err) {
        alert("æ›´æ–°å¤±è´¥: " + err.message);
      }
    }

    async function executeTransfers() {
      try {
        const tx = await contract.executeTransfers();
        await tx.wait();
        alert("æ‰¹é‡è½¬è´¦æˆåŠŸ");
      } catch (err) {
        alert("è½¬è´¦å¤±è´¥: " + err.message);
      }
    }

    async function transferOwnership() {
      const newOwner = document.getElementById("newOwner").value;
      try {
        const tx = await contract.transferOwnership(newOwner);
        await tx.wait();
        alert("æƒé™å·²è½¬ç§»");
      } catch (err) {
        alert("è½¬ç§»å¤±è´¥: " + err.message);
      }
    }
  </script>
</body>
</html>
