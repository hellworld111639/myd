<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SimpleTokenSender DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>ğŸ“¦ SimpleTokenSender Controller</h2>
  <button onclick="connectWallet()">ğŸ”Œ Connect Wallet</button>
  <p id="walletAddress">Not connected</p>
  <hr />

  <h3>ğŸ“Š Contract Status</h3>
  <button onclick="fetchStatus()">ğŸ”„ Refresh</button>
  <p id="autoTransfer">Auto Transfer: </p>
  <p id="maxGasPrice">Max GasPrice: </p>
  <p id="maxGasPerPair">Max Gas/Pair: </p>
  <p id="lastTransfer">Last Transfer Time: </p>
  <p id="canExecute">Can Execute Now: </p>
  <hr />

  <h3>ğŸš€ Execute Transfers</h3>
  <button onclick="executeTransfers()">Execute</button>

  <h3>âš™ï¸ Set Max Gas Price</h3>
  <input type="number" id="newGasPrice" placeholder="Enter new gas price" />
  <button onclick="setMaxGasPrice()">Update</button>

  <h3>â• Add Pair</h3>
  <input type="text" id="token" placeholder="Token address" />
  <input type="text" id="receiver" placeholder="Receiver address" />
  <input type="text" id="name" placeholder="Name" />
  <button onclick="addPair()">Add</button>

  <h3>ğŸ“‹ All Pairs</h3>
  <button onclick="getPairs()">Get Pairs</button>
  <div id="pairs"></div>

  <script>
    const contractAddress = "0x58753f500A22420784f277439b358e3d6cb44AFa";
    const abi = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "addPair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "executeTransfers",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "bool",
				"name": "enabled",
				"type": "bool"
			}
		],
		"name": "AutoTransferToggled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newMaxGas",
				"type": "uint256"
			}
		],
		"name": "MaxGasPerPairUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newMaxGasPrice",
				"type": "uint256"
			}
		],
		"name": "MaxGasPriceUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "PairAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "PairToggled",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newMaxGas",
				"type": "uint256"
			}
		],
		"name": "setMaxGasPerPair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newMaxGasPrice",
				"type": "uint256"
			}
		],
		"name": "setMaxGasPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "enabled",
				"type": "bool"
			}
		],
		"name": "toggleAutoTransfer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "togglePair",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "pairCount",
				"type": "uint256"
			}
		],
		"name": "TransferExecuted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "autoTransferEnabled",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "canExecuteNow",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FIXED_AMOUNT",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FIXED_INTERVAL",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllPairs",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "token",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "receiver",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "isActive",
						"type": "bool"
					},
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					}
				],
				"internalType": "struct SimpleTokenSender.Pair[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lastGlobalTransferTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "maxGasPerPair",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "maxGasPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "pairs",
		"outputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
] // ç”¨ä½ çš„ ABI æ›¿æ¢æ­¤å¤„

    let provider, signer, contract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("è¯·åœ¨ MetaMask ä¸­æ‰“å¼€");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const address = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Connected: " + address;
      contract = new ethers.Contract(contractAddress, abi, signer);
    }

    async function fetchStatus() {
      const auto = await contract.autoTransferEnabled();
      const gasPrice = await contract.MAX_GASPRICE();
      const gasPerPair = await contract.maxGasPerPair();
      const last = await contract.lastGlobalTransferTime();
      const canExec = await contract.canExecuteNow();

      document.getElementById("autoTransfer").innerText = "Auto Transfer: " + auto;
      document.getElementById("maxGasPrice").innerText = "Max GasPrice: " + gasPrice.toString();
      document.getElementById("maxGasPerPair").innerText = "Max Gas/Pair: " + gasPerPair.toString();
      document.getElementById("lastTransfer").innerText = "Last Transfer Time: " + new Date(last.toNumber() * 1000).toLocaleString();
      document.getElementById("canExecute").innerText = "Can Execute Now: " + canExec;
    }

    async function executeTransfers() {
      try {
        const tx = await contract.executeTransfers();
        await tx.wait();
        alert("Transfers executed!");
      } catch (err) {
        alert("Failed: " + err.message);
      }
    }

    async function setMaxGasPrice() {
      const val = document.getElementById("newGasPrice").value;
      try {
        const tx = await contract.setMaxGasPrice(val);
        await tx.wait();
        alert("Max gas price updated.");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function addPair() {
      const token = document.getElementById("token").value;
      const receiver = document.getElementById("receiver").value;
      const name = document.getElementById("name").value;

      try {
        const tx = await contract.addPair(token, receiver, name);
        await tx.wait();
        alert("Pair added.");
      } catch (err) {
        alert("Add failed: " + err.message);
      }
    }

    async function getPairs() {
      const pairs = await contract.getAllPairs();
      const list = pairs.map((p, i) =>
        `<p>#${i} ${p.name} | Token: ${p.token} | Receiver: ${p.receiver} | Active: ${p.isActive}</p>`
      ).join("");
      document.getElementById("pairs").innerHTML = list;
    }
  </script>
</body>
</html>
